<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Task Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include PDF.js from a CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <style>
        body {
            background-image: url('Hampton background.png');
            background-size: 100% auto;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-color: black;
        }

        .stars-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }

        .stars-background::before,
        .stars-background::after,
        .stars-background .star {
            content: '';
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            box-shadow: 0 0 5px 2px rgba(255, 255, 255, 0.8);
            animation: shooting-star linear infinite;
        }

        .stars-background::before {
            top: 10%;
            left: 20%;
            animation-duration: 3s;
            animation-delay: 0s;
        }

        .stars-background::after {
            top: 30%;
            left: 60%;
            animation-duration: 5s;
            animation-delay: 2s;
        }

        .stars-background .star:nth-child(1) {
            top: 50%;
            left: 10%;
            animation-duration: 4s;
            animation-delay: 1s;
        }

        .stars-background .star:nth-child(2) {
            top: 70%;
            left: 80%;
            animation-duration: 6s;
            animation-delay: 3s;
        }

        .stars-background .star:nth-child(3) {
            top: 20%;
            left: 40%;
            animation-duration: 5s;
            animation-delay: 4s;
        }

        @keyframes shooting-star {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            50% {
                opacity: 0.8;
            }
            100% {
                transform: translate(300px, 300px) scale(0);
                opacity: 0;
            }
        }

        #newTopicContent {
            min-height: 100px;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            padding: 0.5rem;
            background: white;
            outline: none;
            position: relative;
        }

        #newTopicContent:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        #newTopicContent img,
        #contentDisplay img,
        #newTopicContent video,
        #contentDisplay video,
        #newTopicContent a.pdf-link,
        #contentDisplay a.pdf-link {
            max-width: 100%;
            height: auto;
            margin: 0.5rem 0;
            cursor: pointer;
            position: relative;
            color: #0000EE;
            text-decoration: underline;
        }

        #newTopicContent img.selected,
        #newTopicContent video.selected,
        #newTopicContent a.pdf-link.selected,
        #contentDisplay img.selected,
        #contentDisplay video.selected,
        #contentDisplay a.pdf-link.selected {
            border: 2px solid #3b82f6;
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }

        .delete-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            line-height: 20px;
            visibility: hidden;
        }

        #newTopicContent img:hover .delete-btn,
        #newTopicContent video:hover .delete-btn,
        #newTopicContent a.pdf-link:hover .delete-btn,
        #contentDisplay img:hover .delete-btn,
        #contentDisplay video:hover .delete-btn,
        #contentDisplay a.pdf-link:hover .delete-btn {
            visibility: visible;
        }

        #newTopicContent a,
        #contentDisplay a {
            color: #0000EE;
            text-decoration: underline;
        }

        #newTopicContent a:hover,
        #contentDisplay a:hover {
            color: #551A8B;
        }

        .toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        #videoInput {
            display: none;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .floating-emoji {
            display: inline-block;
            animation: float 2s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-5px) rotate(2deg);
            }
            100% {
                transform: translateY(0) rotate(0deg);
            }
        }

        /* Modal styles for PDF viewer */
        .pdf-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .pdf-modal-content {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
            position: relative;
        }

        .pdf-modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #ff0000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
        }

        .pdf-modal-close:hover {
            background: #cc0000;
        }

        .pdf-viewer {
            width: 100%;
            height: 500px;
            border: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">
    <div class="stars-background">
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
    </div>

    <!-- PDF Modal -->
    <div id="pdfModal" class="pdf-modal">
        <div class="pdf-modal-content">
            <button id="pdfModalClose" class="pdf-modal-close">X</button>
            <div id="pdfViewer"></div>
        </div>
    </div>

    <div class="w-full max-w-2xl relative z-10">
        <div id="topicListView" class="block">
            <img src="hampton_logo.png" alt="Hampton by Hilton Logo" class="h-24 mx-auto mb-6">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search for a task or keyword..." 
                class="w-full p-3 mb-4 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <div class="bg-white p-4 mb-4 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-2">Create New Topic</h2>
                <input 
                    type="text" 
                    id="newTopicTitle" 
                    placeholder="Enter topic title..." 
                    class="w-full p-2 mb-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <div class="toolbar">
                    <button 
                        id="videoButton" 
                        class="bg-gray-200 p-2 rounded-lg hover:bg-gray-300"
                        title="Upload Video or PDF"
                    >
                        <span class="floating-emoji">ðŸŽ¥</span>
                    </button>
                    <input type="file" id="videoInput" accept="video/*,application/pdf">
                </div>
                <div 
                    id="newTopicContent" 
                    contenteditable="true" 
                    class="w-full mb-2 text-gray-700"
                ></div>
                <button 
                    id="createTopicBtn" 
                    class="w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600"
                >
                    Create Topic
                </button>
            </div>
            <div id="topicsList" class="space-y-4"></div>
        </div>

        <div id="topicDetailsView" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 id="topicTitle" class="text-3xl font-bold text-white"></h1>
                <button 
                    id="deleteButton" 
                    class="text-red-500 hover:text-red-700"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4M7 7h10m-5 4v6m-4-6v6m8-6v6" />
                    </svg>
                </button>
            </div>
            <div id="topicContent" class="bg-white p-4 rounded-lg shadow-md mb-4">
                <div id="contentDisplay" class="text-gray-700"></div>
            </div>
            <button 
                id="backButton" 
                class="w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600"
            >
                Back to Task Guide
            </button>
        </div>
    </div>

    <script>
        const defaultTopics = [
            {
                title: "How to Reset a Password",
                content: 'Go to the user management portal.<br>Select the user account.<br>Click \'Reset Password\' and follow prompts.<br>Ensure the user receives the reset email.<br>Visit <a href="https://example.com/reset" target="_blank">https://example.com/reset</a> for more info.'
            },
            {
                title: "How to Submit a Timesheet",
                content: 'Log into the HR system.<br>Navigate to \'Timesheet\' section.<br>Enter hours worked and submit.<br>Note: Deadlines are every Friday at 5 PM.<br>Check the HR portal: <a href="https://example.com/timesheet" target="_blank">https://example.com/timesheet</a>'
            },
            {
                title: "How to Request Time Off",
                content: 'Open the employee portal.<br>Go to \'Leave Requests\'.<br>Fill out the form and submit.<br>Note: Requests need 2 weeks\' notice.<br>Submit requests at <a href="https://example.com/leave" target="_blank">https://example.com/leave</a>'
            }
        ];

        let db;
        let topics = defaultTopics;
        const dbRequest = indexedDB.open("EmployeeTaskGuideDB", 1);

        dbRequest.onupgradeneeded = (event) => {
            db = event.target.result;
            const store = db.createObjectStore("topics", { keyPath: "id" });
            store.put({ id: "employeeTaskGuideTopics", data: defaultTopics });
        };

        dbRequest.onsuccess = (event) => {
            db = event.target.result;
            loadTopics();
        };

        dbRequest.onerror = (event) => {
            console.error("Error opening IndexedDB:", event.target.error);
            topics = defaultTopics;
            renderTopics();
        };

        function loadTopics() {
            const transaction = db.transaction(["topics"], "readonly");
            const store = transaction.objectStore("topics");
            const request = store.get("employeeTaskGuideTopics");

            request.onsuccess = (event) => {
                topics = event.target.result ? event.target.result.data : defaultTopics;
                console.log("Loaded topics from IndexedDB:", topics.map(t => t.title));
                renderTopics();
                attachPDFClickHandlers();
            };

            request.onerror = (event) => {
                console.error("Error loading topics from IndexedDB:", event.target.error);
                topics = defaultTopics;
                renderTopics();
                attachPDFClickHandlers();
            };
        }

        function saveTopics() {
            const transaction = db.transaction(["topics"], "readwrite");
            const store = transaction.objectStore("topics");
            const request = store.put({ id: "employeeTaskGuideTopics", data: topics });

            request.onsuccess = () => {
                console.log("Saved topics to IndexedDB:", topics.map(t => t.title));
            };

            request.onerror = (event) => {
                console.error("Error saving topics to IndexedDB:", event.target.error);
            };
        }

        let isSubmitting = false;

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function convertTextToLinks(text) {
            const urlRegex = /(https?:\/\/[^\s<]+)(?![^<]*>|[^<>]*<\/a>)/g;
            return text.replace(urlRegex, (url) => {
                return `<a href="${url}" target="_blank">${url}</a>`;
            });
        }

        // Function to view PDF using PDF.js
        async function viewPDF(base64Data) {
            try {
                // Remove the data URL prefix to get the Base64 string
                const base64String = base64Data.split(',')[1];
                // Convert Base64 to binary
                const binaryString = atob(base64String);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                // Load the PDF using PDF.js
                const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
                const pdfViewer = document.getElementById("pdfViewer");
                pdfViewer.innerHTML = ""; // Clear previous content

                // Render all pages
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1.0 });

                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    pdfViewer.appendChild(canvas);

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    await page.render(renderContext).promise;
                }

                // Show the modal
                const pdfModal = document.getElementById("pdfModal");
                pdfModal.style.display = "flex";
            } catch (e) {
                console.error("Failed to render PDF:", e);
                alert("Unable to render the PDF. You can download it by right-clicking the link and selecting 'Save link as...'.");
            }
        }

        // Function to attach click handlers to PDF links
        function attachPDFClickHandlers() {
            const pdfLinks = document.querySelectorAll("a.pdf-link");
            pdfLinks.forEach(link => {
                link.removeEventListener("click", handlePDFClick);
                link.addEventListener("click", handlePDFClick);
            });
        }

        function handlePDFClick(e) {
            e.preventDefault();
            const link = e.target;
            if (link.classList.contains("selected")) return; // Allow deletion when selected
            const base64Data = link.getAttribute("href");
            viewPDF(base64Data);
        }

        // Modal close handler
        const pdfModal = document.getElementById("pdfModal");
        const pdfModalClose = document.getElementById("pdfModalClose");
        pdfModalClose.addEventListener("click", () => {
            pdfModal.style.display = "none";
            document.getElementById("pdfViewer").innerHTML = "";
        });

        // Close modal when clicking outside the content
        pdfModal.addEventListener("click", (e) => {
            if (e.target === pdfModal) {
                pdfModal.style.display = "none";
                document.getElementById("pdfViewer").innerHTML = "";
            }
        });

        const contentEditor = document.getElementById("newTopicContent");
        contentEditor.addEventListener("dragover", (e) => {
            e.preventDefault();
        });

        contentEditor.addEventListener("drop", async (e) => {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith("image/")) {
                    const base64 = await fileToBase64(file);
                    const img = document.createElement("img");
                    img.src = base64;
                    img.style.maxWidth = "100%";
                    img.style.height = "auto";
                    const wrapper = document.createElement("div");
                    wrapper.style.position = "relative";
                    wrapper.style.display = "inline-block";
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "delete-btn";
                    deleteBtn.textContent = "X";
                    deleteBtn.onclick = () => wrapper.remove();
                    wrapper.appendChild(img);
                    wrapper.appendChild(deleteBtn);
                    contentEditor.appendChild(wrapper);
                } else if (file.type.startsWith("video/")) {
                    const base64 = await fileToBase64(file);
                    const video = document.createElement("video");
                    video.src = base64;
                    video.controls = true;
                    video.style.maxWidth = "100%";
                    video.style.height = "auto";
                    const wrapper = document.createElement("div");
                    wrapper.style.position = "relative";
                    wrapper.style.display = "inline-block";
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "delete-btn";
                    deleteBtn.textContent = "X";
                    deleteBtn.onclick = () => wrapper.remove();
                    wrapper.appendChild(video);
                    wrapper.appendChild(deleteBtn);
                    contentEditor.appendChild(wrapper);
                } else if (file.type === "application/pdf") {
                    const base64 = await fileToBase64(file);
                    const pdfLink = document.createElement("a");
                    pdfLink.className = "pdf-link";
                    pdfLink.href = base64;
                    pdfLink.textContent = `[PDF: ${file.name}]`;
                    pdfLink.setAttribute("data-type", "pdf");
                    const wrapper = document.createElement("div");
                    wrapper.style.position = "relative";
                    wrapper.style.display = "inline-block";
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "delete-btn";
                    deleteBtn.textContent = "X";
                    deleteBtn.onclick = () => wrapper.remove();
                    wrapper.appendChild(pdfLink);
                    wrapper.appendChild(deleteBtn);
                    contentEditor.appendChild(wrapper);
                }
            }
            attachPDFClickHandlers();
        });

        contentEditor.addEventListener("paste", async (e) => {
            e.preventDefault();
            const items = e.clipboardData.items;

            for (const item of items) {
                if (item.type.startsWith("image/")) {
                    const file = item.getAsFile();
                    const base64 = await fileToBase64(file);
                    const img = document.createElement("img");
                    img.src = base64;
                    img.style.maxWidth = "100%";
                    img.style.height = "auto";
                    const wrapper = document.createElement("div");
                    wrapper.style.position = "relative";
                    wrapper.style.display = "inline-block";
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "delete-btn";
                    deleteBtn.textContent = "X";
                    deleteBtn.onclick = () => wrapper.remove();
                    wrapper.appendChild(img);
                    wrapper.appendChild(deleteBtn);
                    const selection = window.getSelection();
                    if (selection.rangeCount) {
                        const range = selection.getRangeAt(0);
                        range.insertNode(wrapper);
                        range.collapse(false);
                    } else {
                        contentEditor.appendChild(wrapper);
                    }
                } else if (item.type === "text/plain") {
                    item.getAsString((text) => {
                        const convertedText = convertTextToLinks(text);
                        const div = document.createElement("div");
                        div.innerHTML = convertedText;
                        const selection = window.getSelection();
                        if (selection.rangeCount) {
                            const range = selection.getRangeAt(0);
                            range.deleteContents();
                            range.insertNode(div);
                            range.collapse(false);
                        } else {
                            contentEditor.appendChild(div);
                        }
                    });
                }
            }
            attachPDFClickHandlers();
        });

        contentEditor.addEventListener("keydown", (e) => {
            if (e.key === "Backspace" || e.key === "Delete") {
                const selection = window.getSelection();
                if (selection.rangeCount) {
                    const range = selection.getRangeAt(0);
                    const startContainer = range.startContainer;
                    const startOffset = range.startOffset;
                    const endContainer = range.endContainer;
                    const endOffset = range.endOffset;

                    if (!range.collapsed) {
                        const selectedNodes = range.cloneContents().querySelectorAll("video, img, a.pdf-link");
                        if (selectedNodes.length > 0) {
                            range.deleteContents();
                            e.preventDefault();
                            return;
                        }
                    }

                    if (range.collapsed) {
                        if (startContainer.nodeType === Node.TEXT_NODE) {
                            if (startOffset === 0) {
                                const previousSibling = startContainer.parentElement.previousSibling;
                                if (previousSibling && (previousSibling.querySelector("video") || previousSibling.querySelector("img") || previousSibling.querySelector("a.pdf-link"))) {
                                    previousSibling.remove();
                                    e.preventDefault();
                                    return;
                                }
                            }
                            if (startOffset === startContainer.length) {
                                const nextSibling = startContainer.parentElement.nextSibling;
                                if (nextSibling && (nextSibling.querySelector("video") || nextSibling.querySelector("img") || nextSibling.querySelector("a.pdf-link"))) {
                                    nextSibling.remove();
                                    e.preventDefault();
                                    return;
                                }
                            }
                        }
                        if (startContainer.nodeType === Node.ELEMENT_NODE && (startContainer.tagName === "VIDEO" || startContainer.tagName === "IMG" || (startContainer.tagName === "A" && startContainer.className === "pdf-link"))) {
                            startContainer.parentElement.remove();
                            e.preventDefault();
                            return;
                        }
                    }
                }
            }
        });

        contentEditor.addEventListener("click", (e) => {
            const target = e.target;
            if (target.tagName === "VIDEO" || target.tagName === "IMG" || (target.tagName === "A" && target.className === "pdf-link")) {
                const allMedia = contentEditor.querySelectorAll("video, img, a.pdf-link");
                allMedia.forEach(element => element.classList.remove("selected"));
                target.classList.add("selected");
                const selection = window.getSelection();
                selection.removeAllRanges();
                const range = document.createRange();
                range.selectNode(target);
                selection.addRange(range);
            } else {
                const allMedia = contentEditor.querySelectorAll("video, img, a.pdf-link");
                allMedia.forEach(element => element.classList.remove("selected"));
            }
        });

        const videoButton = document.getElementById("videoButton");
        const videoInput = document.getElementById("videoInput");
        videoButton.addEventListener("click", () => {
            videoInput.click();
        });

        videoInput.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.type.startsWith("video/")) {
                    const base64 = await fileToBase64(file);
                    const video = document.createElement("video");
                    video.src = base64;
                    video.controls = true;
                    video.style.maxWidth = "100%";
                    video.style.height = "auto";
                    const wrapper = document.createElement("div");
                    wrapper.style.position = "relative";
                    wrapper.style.display = "inline-block";
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "delete-btn";
                    deleteBtn.textContent = "X";
                    deleteBtn.onclick = () => wrapper.remove();
                    wrapper.appendChild(video);
                    wrapper.appendChild(deleteBtn);
                    contentEditor.appendChild(wrapper);
                } else if (file.type === "application/pdf") {
                    const base64 = await fileToBase64(file);
                    const pdfLink = document.createElement("a");
                    pdfLink.className = "pdf-link";
                    pdfLink.href = base64;
                    pdfLink.textContent = `[PDF: ${file.name}]`;
                    pdfLink.setAttribute("data-type", "pdf");
                    const wrapper = document.createElement("div");
                    wrapper.style.position = "relative";
                    wrapper.style.display = "inline-block";
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "delete-btn";
                    deleteBtn.textContent = "X";
                    deleteBtn.onclick = () => wrapper.remove();
                    wrapper.appendChild(pdfLink);
                    wrapper.appendChild(deleteBtn);
                    contentEditor.appendChild(wrapper);
                }
            }
            videoInput.value = "";
            attachPDFClickHandlers();
        });

        function renderTopics(searchTerm = "") {
            const topicsList = document.getElementById("topicsList");
            topicsList.innerHTML = "";

            const filteredTopics = topics.filter(topic => {
                if (!searchTerm) return true;
                const lowerSearch = searchTerm.toLowerCase();
                const titleMatch = topic.title.toLowerCase().includes(lowerSearch);
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = topic.content;
                const textContent = tempDiv.textContent.toLowerCase();
                const contentMatch = textContent.includes(lowerSearch);
                return titleMatch || contentMatch;
            });

            if (filteredTopics.length === 0) {
                topicsList.innerHTML = '<p class="text-gray-500">No results found.</p>';
                return;
            }

            filteredTopics.forEach((topic) => {
                const topicDiv = document.createElement("div");
                topicDiv.className = "bg-white p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-50";
                topicDiv.innerHTML = `
                    <h2 class="text-xl font-semibold">${topic.title}</h2>
                `;
                topicDiv.addEventListener("click", () => {
                    showTopicDetails(topic);
                });
                topicsList.appendChild(topicDiv);
            });
        }

        function showTopicDetails(topic) {
            const topicListView = document.getElementById("topicListView");
            const topicDetailsView = document.getElementById("topicDetailsView");
            const topicTitle = document.getElementById("topicTitle");
            const contentDisplay = document.getElementById("contentDisplay");

            topicTitle.textContent = topic.title;
            document.getElementById("deleteButton").setAttribute("data-title", topic.title);

            if (!topic.content) {
                contentDisplay.textContent = "No description available.";
            } else {
                contentDisplay.innerHTML = topic.content;
            }

            topicListView.classList.add("hidden");
            topicDetailsView.classList.remove("hidden");
            attachPDFClickHandlers();
        }

        function goBack() {
            const topicListView = document.getElementById("topicListView");
            const topicDetailsView = document.getElementById("topicDetailsView");
            topicListView.classList.remove("hidden");
            topicDetailsView.classList.add("hidden");
            renderTopics(document.getElementById("searchInput").value);
        }

        function createTopic() {
            if (isSubmitting) {
                console.log("Submission in progress, ignoring click.");
                return;
            }

            isSubmitting = true;
            const createTopicBtn = document.getElementById("createTopicBtn");
            createTopicBtn.disabled = true;

            const titleInput = document.getElementById("newTopicTitle");
            const contentEditor = document.getElementById("newTopicContent");
            const title = titleInput.value.trim().replace(/\s+/g, ' ');
            const content = contentEditor.innerHTML.trim();

            if (!title || content.length === 0) {
                alert("Please enter a title and description/notes.");
                isSubmitting = false;
                createTopicBtn.disabled = false;
                return;
            }

            console.log("Current titles in topics array:", topics.map(t => t.title));
            console.log("New title to be added:", title);

            const isDuplicate = topics.some(topic => {
                const existingTitle = topic.title ? topic.title.trim().replace(/\s+/g, ' ').toLowerCase() : "";
                const newTitle = title.trim().replace(/\s+/g, ' ').toLowerCase();
                console.log(`Comparing "${existingTitle}" with "${newTitle}"`);
                return existingTitle === newTitle;
            });

            if (isDuplicate) {
                alert("A topic with this title already exists.");
                isSubmitting = false;
                createTopicBtn.disabled = false;
                return;
            }

            topics.push({
                title,
                content
            });

            saveTopics();

            setTimeout(() => {
                titleInput.value = "";
                titleInput.setAttribute('value', '');
                contentEditor.innerHTML = "";
                isSubmitting = false;
                createTopicBtn.disabled = false;
                console.log("Form cleared after submission. Title input value:", titleInput.value);
                renderTopics();
            }, 100);
        }

        function deleteTopic(title) {
            console.log(`Attempting to delete topic: ${title}`);
            const confirmDelete = confirm(`Are you sure you want to delete "${title}"?`);
            if (confirmDelete) {
                const index = topics.findIndex(topic => topic.title === title);
                if (index !== -1) {
                    topics.splice(index, 1);
                    console.log(`Deleted topic: ${title}`);
                    saveTopics();
                    goBack();
                } else {
                    alert("Error: Topic not found.");
                }
            }
        }

        const createTopicBtn = document.getElementById("createTopicBtn");
        createTopicBtn.removeEventListener("click", createTopic);
        createTopicBtn.addEventListener("click", createTopic);

        document.getElementById("searchInput").addEventListener("input", (e) => {
            renderTopics(e.target.value);
        });

        document.getElementById("backButton").addEventListener("click", goBack);

        document.getElementById("deleteButton").addEventListener("click", () => {
            const title = document.getElementById("deleteButton").getAttribute("data-title");
            if (title) {
                deleteTopic(title);
            } else {
                alert("Error: No topic selected for deletion.");
            }
        });
    </script>
</body>
</html>